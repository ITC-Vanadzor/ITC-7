Create database HDM;
Use HDM;
Create table user (id int not null auto_increment, username varchar(20) not null, email varchar(35) not null, password varchar(256) not null, primary key(id), key indexEmail (email));
Create table field (field_id int not null auto_increment, opt_field varchar(55) not null, primary key(field_id));
Create table account (opt_id int not null auto_increment, opt_value varchar(255) not null, u_id int not null, f_id int not null, primary key(opt_id), foreign key(u_id) references user(id), foreign key(f_id) references field(field_id));
Create table receipt (id int not null auto_increment, time datetime not null, market varchar(50) not null, sum int not null, date date not null, comment text , u_id int not null, primary key(id), foreign key(u_id) references user(id), key indexTime (time, market));
Insert into field(field_id, opt_field) values (1, 'surname'), (2, 'birthday'), (3, 'image');
Create view userView AS select user.id as id, user.username as name, user.email as email, user.password as pass, field.opt_field as field, account.opt_value as val from ((account join user) join field) where ((account.u_id=user.id) and (account.f_id=field.field_id));



Create view info AS 
	select user.id as id, 
	user.username as name, 
	user.email as email, 
	user.password as pass 
 from ((account join user) join field) 
 where ((account.u_id=user.id) and (account.f_id=field.field_id));




Create view account_extended as 
(   
	select user.id as id, 
	user.username as name, 
	user.email as email, 
	user.password as pass from user,       
	case when f_id = 1 then f_value end as surname,     
	case when f_id = 2 then f_value end as birthday,     
	case when f_id = 3 then f_value end as image   
from account );


Create view account_pivot as 
(
  select 
    id, 
    coalesce(A, 0) as A, 
    coalesce(B, 0) as B, 
    coalesce(C, 0) as C 
  from history_itemvalue_pivot 
);


SELECT  u_id,
        MAX(IF(`f_id` = 1, f_value, NULL)) surname,
        MAX(IF(`f_id` = 2, f_value, NULL)) birthday,
        MAX(IF(`f_id` = 3, f_value, NULL)) image
FROM    account GROUP   BY u_id;


SELECT  u_id,         
		MAX(IF(`f_id` = 1, f_value, "...")) surname,
		MAX(IF(`f_id` = 2, f_value, "...")) birthday,
		MAX(IF(`f_id` = 3, f_value, "...")) image 
FROM    account GROUP   BY u_id;
